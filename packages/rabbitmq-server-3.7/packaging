#/* vim: set ft=sh : */

set -e

RMQ_VERSION="3.7.9"
RMQ_VERSION_SEMVER="3.7.9"
ERLANG_VERSION="20.3"
RABBITMQ_SERVER_PATH="rabbitmq-server-3.7"

echo "$RMQ_VERSION_SEMVER" > "$BOSH_INSTALL_TARGET/rmq_version"
echo "$ERLANG_VERSION" > "$BOSH_INSTALL_TARGET/erlang_version"

tar xf "${RABBITMQ_SERVER_PATH}/rabbitmq-server-generic-unix-$RMQ_VERSION.tar.xz"

cp -a "rabbitmq_server-$RMQ_VERSION"/* "$BOSH_INSTALL_TARGET"

cp -a "$RABBITMQ_SERVER_PATH/prometheus-3.5.1.ez" "$BOSH_INSTALL_TARGET/plugins/"
cp -a "$RABBITMQ_SERVER_PATH/prometheus_cowboy-0.1.4.ez" "$BOSH_INSTALL_TARGET/plugins/"
cp -a "$RABBITMQ_SERVER_PATH/prometheus_httpd-2.1.8.ez" "$BOSH_INSTALL_TARGET/plugins/"
cp -a "$RABBITMQ_SERVER_PATH/prometheus_rabbitmq_exporter-3.7.2.4.ez" "$BOSH_INSTALL_TARGET/plugins/"

cp -a "$RABBITMQ_SERVER_PATH/accept-0.3.3.ez" "$BOSH_INSTALL_TARGET/plugins/"

mv "$BOSH_INSTALL_TARGET/sbin" "$BOSH_INSTALL_TARGET/privbin"

mkdir "$BOSH_INSTALL_TARGET/bin"
for script in rabbitmqctl rabbitmq-server rabbitmq-plugins
do
    cp rabbitmq-server/rabbitmq-script-wrapper "$BOSH_INSTALL_TARGET/bin/$script"
    chmod 0755 "$BOSH_INSTALL_TARGET/bin/$script"
done

cp -a rabbitmq-server/rabbitmq-defaults "$BOSH_INSTALL_TARGET/privbin/"
